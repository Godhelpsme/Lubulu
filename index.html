<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Lubulu - 健康决策轮盘应用，帮助用户在健康和不健康选择之间做出决定" />
  <meta name="keywords" content="健康决策, 轮盘, 自制力, 健康生活" />
  <meta name="author" content="Lubulu Team" />
  <meta name="theme-color" content="#667eea" />
  
  <!-- PWA相关meta标签 -->
  <link rel="manifest" href="/manifest.json" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="Lubulu" />
  
  <!-- PWA图标 -->
  <link rel="apple-touch-icon" href="/icons/icon-192x192.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/icon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="/icons/icon-16x16.png" />
  
  <!-- SEO优化 -->
  <meta property="og:title" content="Lubulu - 健康决策轮盘" />
  <meta property="og:description" content="一个帮助用户在健康和不健康选择之间做出决定的互动轮盘应用" />
  <meta property="og:image" content="/icons/icon-512x512.png" />
  <meta property="og:url" content="https://lubulu.app" />
  <meta property="og:type" content="website" />
  
  <!-- 性能优化 -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link rel="dns-prefetch" href="https://api.lubulu.app" />
  
  <!-- 字体预加载 -->
  <link rel="preload" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&family=Roboto:wght@400;700&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'" />
  <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&family=Roboto:wght@400;700&display=swap" /></noscript>
  
  <!-- CSS模块化加载 -->
  <link rel="preload" href="/src/css/base.css" as="style" />
  <link rel="preload" href="/src/css/components.css" as="style" />
  <link rel="stylesheet" href="/src/css/base.css" />
  <link rel="stylesheet" href="/src/css/components.css" />
  <link rel="stylesheet" href="/src/css/forms.css" />
  <link rel="stylesheet" href="/src/css/responsive.css" />
  
  <!-- JavaScript模块预加载 -->
  <link rel="modulepreload" href="/src/js/main.js" />
  <link rel="modulepreload" href="/src/js/core/roulette.js" />
  <link rel="modulepreload" href="/src/js/core/calendar.js" />
  <link rel="modulepreload" href="/src/js/core/statistics.js" />
  
  <!-- CSP安全策略 -->
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com;
    style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
    font-src 'self' https://fonts.gstatic.com;
    img-src 'self' data: blob:;
    connect-src 'self' https://api.lubulu.app;
    worker-src 'self';
    manifest-src 'self';
  " />
  
  <title>Lubulu - 健康决策轮盘</title>
  
  <!-- 第三方库 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" async></script>
</head>
<body>
  <!-- 加载指示器 -->
  <div id="loadingSpinner" class="loading-spinner">
    <div class="spinner"></div>
    <p>Lubulu 正在加载...</p>
  </div>

  <!-- 应用更新提示 -->
  <div id="updateAvailable" class="update-banner hidden">
    <span>发现新版本！</span>
    <button id="updateBtn" class="update-btn">立即更新</button>
    <button id="dismissUpdateBtn" class="dismiss-btn">×</button>
  </div>

  <!-- 离线提示 -->
  <div id="offlineNotice" class="offline-notice hidden">
    <span>当前处于离线状态，部分功能可能受限</span>
  </div>

  <!-- AppBar -->
  <header class="app-bar glass">
    <div class="app-bar__content">
      <h1 class="title">Lubulu</h1>
      <button id="settingsBtn" class="settings-btn" aria-label="设置">
        <svg width="32" height="32" viewBox="0 0 24 24" fill="none">
          <path d="M12 2C13.1 2 14 2.9 14 4C14 5.1 13.1 6 12 6C10.9 6 10 5.1 10 4C10 2.9 10.9 2 12 2ZM21 9V7L19 6.5C18.89 6.15 18.76 5.82 18.6 5.5L19.5 4L18 2.5L16.5 3.4C16.18 3.24 15.85 3.11 15.5 3L15 1H13L12.5 3C12.15 3.11 11.82 3.24 11.5 3.4L10 2.5L8.5 4L9.4 5.5C9.24 5.82 9.11 6.15 9 6.5L7 7V9L9 9.5C9.11 9.85 9.24 10.18 9.4 10.5L8.5 12L10 13.5L11.5 12.6C11.82 12.76 12.15 12.89 12.5 13L13 15H15L15.5 13C15.85 12.89 16.18 12.76 16.5 12.6L18 13.5L19.5 12L18.6 10.5C18.76 10.18 18.89 9.85 19 9.5L21 9Z" fill="currentColor"/>
        </svg>
      </button>
    </div>
  </header>

  <main>
    <!-- Primary Section: Roulette Card -->
    <section class="roulette-section">
      <div class="roulette-card glass">
        <div class="roulette-container">
          <canvas id="rouletteCanvas" width="480" height="480"></canvas>
          <div class="roulette-pointer"></div>
        </div>
        <button id="spinBtn" class="spin-btn">SPIN</button>
        <div id="tooltip" class="tooltip hidden">今日仅可抽取 1 次</div>
        
        <!-- Result Display -->
        <div id="resultDisplay" class="result-display hidden">
          <div class="result-icon"></div>
          <div class="result-text"></div>
          <div class="pity-notice hidden" id="pityNotice">本次触发保底</div>
          <div class="result-choice hidden" id="resultChoice">
            <p>你选择:</p>
            <div class="choice-buttons">
              <button id="chooseYes" class="choice-btn yes-btn">Lu</button>
              <button id="chooseNo" class="choice-btn no-btn">不Lu</button>
            </div>
          </div>
          <div class="result-actions hidden" id="resultActions">
            <button id="shareResult" class="share-result-btn">分享结果</button>
            <button id="confirmResult" class="confirm-result-btn">确定</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Statistics Section -->
    <section class="stats-section">
      <div class="stats-card neu-flat">
        <h3>统计记录</h3>
        <div class="stats-grid">
          <div class="stat-item">
            <div class="stat-number success" id="successCount">0</div>
            <div class="stat-label">Lu次数</div>
          </div>
          <div class="stat-item">
            <div class="stat-number failure" id="failureCount">0</div>
            <div class="stat-label">不Lu次数</div>
          </div>
          <div class="stat-item">
            <div class="stat-number total" id="totalCount">0</div>
            <div class="stat-label">总次数</div>
          </div>
          <div class="stat-item">
            <div class="stat-number rate" id="successRate">0%</div>
            <div class="stat-label">克制率</div>
          </div>
        </div>
      </div>
    </section>

    <!-- Secondary Section: Daily Calendar -->
    <section class="calendar-section">
      <div class="calendar-card neu-flat" id="calendar"></div>
    </section>
  </main>

  <!-- Footer -->
  <footer class="footer">
    <div class="footer-content">
      <span>Copyright © 2025 ius | Licensed under MIT License | <a href="#" id="studioLink" target="_blank">Lubulu</a></span>
    </div>
  </footer>

  <!-- Settings Dialog -->
  <div id="settingsDialog" class="dialog hidden glass">
    <h3>设置</h3>
    <div class="settings-content">
      <div class="setting-item">
        <label for="luProbability">Lu概率设置:</label>
        <input type="range" id="luProbability" min="1" max="98" value="1" step="1">
        <span id="luProbabilityValue">1</span>
        <span class="setting-hint">设置Lu的概率（1-98），剩余为不Lu的概率</span>
      </div>
      
      <div class="setting-item">
        <label for="pityDays">保底天数:</label>
        <input type="number" id="pityDays" min="0" max="365" value="0">
        <span class="setting-hint">0表示不启用保底，设置天数后如果连续不Lu超过此天数将必Lu</span>
      </div>
      
      <div class="setting-item">
        <label>抽取模式:</label>
        <div class="mode-buttons">
          <button id="singleModeBtn" class="mode-btn active">单次模式</button>
          <button id="multiModeBtn" class="mode-btn">多次模式</button>
        </div>
        <span class="setting-hint">单次模式：每天只能抽取一次；多次模式：每天第一次记录，后续仅显示结果</span>
      </div>
      
      <div class="setting-item">
        <label>数据管理:</label>
        <div class="data-buttons">
          <button id="exportDataBtn" class="btn-secondary">导出数据</button>
          <button id="importDataBtn" class="btn-secondary">导入数据</button>
          <input type="file" id="importFileInput" accept=".json" style="display: none;">
        </div>
      </div>
    </div>
    
    <div class="dialog-actions">
      <button id="settingsCancelBtn" class="btn-secondary">取消</button>
      <button id="settingsSaveBtn" class="btn-primary">保存</button>
    </div>
  </div>

  <!-- Confirmation Dialog -->
  <div id="confirmDialog" class="dialog hidden glass">
    <p>确定今日要抽取?</p>
    <div class="dialog-actions">
      <button id="cancelBtn" class="btn-secondary">取消</button>
      <button id="confirmBtn" class="btn-primary">确定</button>
    </div>
  </div>

  <!-- Import Confirmation Dialog -->
  <div id="importConfirmDialog" class="dialog hidden glass">
    <h3>确认导入</h3>
    <p>确定要导入数据吗？这将覆盖当前的所有数据！</p>
    <div class="dialog-actions">
      <button id="importCancelBtn" class="btn-secondary">取消</button>
      <button id="importConfirmBtn" class="btn-primary">确定导入</button>
    </div>
  </div>

  <!-- Notification Dialog -->
  <div id="notificationDialog" class="notification-dialog hidden">
    <div class="notification-content">
      <div class="notification-icon"></div>
      <div class="notification-message"></div>
      <button id="notificationOkBtn" class="btn-primary">确定</button>
    </div>
  </div>

  <!-- Overlay for dialogs -->
  <div id="overlay" class="overlay hidden"></div>

  <!-- Update Log Dialog -->
  <div id="updateLogDialog" class="dialog hidden glass">
    <h3>🎉 更新日志 - v2.0</h3>
    <div class="update-content">
      <div class="update-item">
        <h4>🎯 新功能</h4>
        <ul>
          <li>✨ 支持自定义Lu概率设置（1-98%）</li>
          <li>🎨 轮盘外观根据概率动态变化</li>
          <li>📝 支持修改历史记录状态</li>
          <li>🔄 新增多次抽取模式</li>
          <li>📊 优化统计显示</li>
        </ul>
      </div>
      
      <div class="update-item">
        <h4>🛠️ 使用说明</h4>
        <ul>
          <li>在设置中调整Lu概率，轮盘会实时更新</li>
          <li>点击日历中的日期可以修改当天的状态</li>
          <li>多次模式下可以反复抽取，但只有第一次记录</li>
        </ul>
      </div>
    </div>
    
    <div class="dialog-actions">
      <button id="updateLogOkBtn" class="btn-primary">我知道了</button>
    </div>
  </div>

  <!-- History Edit Dialog -->
  <div id="historyEditDialog" class="dialog hidden glass">
    <h3>编辑历史记录</h3>
    <p id="historyEditDate"></p>
    <div class="history-edit-buttons">
      <button id="setLuBtn" class="choice-btn yes-btn">设为Lu</button>
      <button id="setNoLuBtn" class="choice-btn no-btn">设为不Lu</button>
      <button id="clearHistoryBtn" class="btn-secondary">清除记录</button>
    </div>
    <div class="dialog-actions">
      <button id="historyEditCancelBtn" class="btn-secondary">取消</button>
    </div>
  </div>

  <script type="module" src="/src/js/main.js"></script>
  
  <!-- Service Worker注册 -->
  <script>
    // Service Worker注册
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then((registration) => {
            console.log('SW registered: ', registration);
            
            // 检查更新
            registration.addEventListener('updatefound', () => {
              const newWorker = registration.installing;
              newWorker.addEventListener('statechange', () => {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                  // 显示更新提示
                  document.getElementById('updateAvailable').classList.remove('hidden');
                }
              });
            });
          })
          .catch((registrationError) => {
            console.log('SW registration failed: ', registrationError);
          });
      });
      
      // 监听SW消息
      navigator.serviceWorker.addEventListener('message', (event) => {
        if (event.data && event.data.type === 'CACHE_UPDATED') {
          document.getElementById('updateAvailable').classList.remove('hidden');
        }
      });
    }
    
    // 网络状态监听
    window.addEventListener('online', () => {
      document.getElementById('offlineNotice').classList.add('hidden');
    });
    
    window.addEventListener('offline', () => {
      document.getElementById('offlineNotice').classList.remove('hidden');
    });
    
    // 更新按钮事件
    document.addEventListener('DOMContentLoaded', () => {
      const updateBtn = document.getElementById('updateBtn');
      const dismissBtn = document.getElementById('dismissUpdateBtn');
      
      updateBtn?.addEventListener('click', () => {
        if (navigator.serviceWorker.controller) {
          navigator.serviceWorker.controller.postMessage({ type: 'SKIP_WAITING' });
          window.location.reload();
        }
      });
      
      dismissBtn?.addEventListener('click', () => {
        document.getElementById('updateAvailable').classList.add('hidden');
      });
      
      // 隐藏加载指示器
      const spinner = document.getElementById('loadingSpinner');
      if (spinner) {
        spinner.style.display = 'none';
      }
    });
    
    // 错误处理
    window.addEventListener('error', (event) => {
      console.error('Global error:', event.error);
      // 可以在这里添加错误上报逻辑
    });
    
    window.addEventListener('unhandledrejection', (event) => {
      console.error('Unhandled promise rejection:', event.reason);
      // 可以在这里添加错误上报逻辑
    });
    
    // 性能监控
    window.addEventListener('load', () => {
      if ('performance' in window) {
        const perfData = performance.getEntriesByType('navigation')[0];
        console.log('Page load time:', perfData.loadEventEnd - perfData.fetchStart, 'ms');
      }
    });
  </script>
</body>
</html> 