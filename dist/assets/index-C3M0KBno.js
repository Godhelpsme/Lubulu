(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const a of n.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function e(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=e(i);fetch(i.href,n)}})();function y(){const h=new Date,t=new Date(h.getTime()+8*60*60*1e3),e=t.getUTCFullYear(),s=String(t.getUTCMonth()+1).padStart(2,"0"),i=String(t.getUTCDate()).padStart(2,"0");return`${e}-${s}-${i}`}function b(h=0,t=1){if(window.crypto&&window.crypto.getRandomValues){const e=new Uint32Array(1);return window.crypto.getRandomValues(e),h+e[0]/4294967296*(t-h)}return h+Math.random()*(t-h)}function v(h,t){let e;return function(...s){clearTimeout(e),e=setTimeout(()=>h(...s),t)}}class C{constructor(t=1){this.setProbability(t)}setProbability(t){this.probability=Math.max(1,Math.min(98,t)),this.totalSlices=100}get luSliceCount(){return this.probability}get noLuSliceCount(){return this.totalSlices-this.probability}roll(){const t=b(0,this.totalSlices),e=Math.floor(t);return{isLu:e<this.probability,sliceIndex:e,probability:this.probability}}forceResult(t){const e=Math.floor(t?b(0,this.probability):b(this.probability,this.totalSlices));return{isLu:t,sliceIndex:e,probability:this.probability,isForced:!0}}getWheelConfig(){return{totalSlices:this.totalSlices,luSlices:this.luSliceCount,noLuSlices:this.noLuSliceCount,colors:{lu:"#F44336",noLu:"#4CAF50",border:"#FFFFFF"}}}}class D{constructor(t){if(!t)throw new Error("Canvas element is required");this.canvas=t,this.ctx=t.getContext("2d"),this.currentAngle=0,this.isAnimating=!1,this.animationId=null,this.ctx.imageSmoothingEnabled=!0,this.ctx.imageSmoothingQuality="high",this.drawDebounced=v(()=>this.draw(),16),this.config={totalSlices:100,luSlices:1,noLuSlices:99,colors:{lu:"#F44336",noLu:"#4CAF50",border:"#FFFFFF"}},this.setupCanvas()}setupCanvas(){const t=this.canvas.getBoundingClientRect(),e=window.devicePixelRatio||1;this.canvas.width=t.width*e,this.canvas.height=t.height*e,this.ctx.scale(e,e),this.canvas.style.width=t.width+"px",this.canvas.style.height=t.height+"px",this.centerX=t.width/2,this.centerY=t.height/2,this.radius=Math.min(this.centerX,this.centerY)-10}updateConfig(t){this.config={...this.config,...t},this.draw()}draw(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);const t=2*Math.PI/this.config.totalSlices;for(let e=0;e<this.config.totalSlices;e++){const s=e*t+this.currentAngle,i=(e+1)*t+this.currentAngle,n=e<this.config.luSlices;this.drawSlice(s,i,n,e)}this.drawCenter()}drawSlice(t,e,s,i){this.ctx.beginPath(),this.ctx.moveTo(this.centerX,this.centerY),this.ctx.arc(this.centerX,this.centerY,this.radius,t,e),this.ctx.closePath(),this.ctx.fillStyle=s?this.config.colors.lu:this.config.colors.noLu,this.ctx.fill(),this.ctx.strokeStyle=this.config.colors.border,this.ctx.lineWidth=1,this.ctx.stroke(),this.shouldDrawText(i,s)&&this.drawSliceText(t,e,s)}shouldDrawText(t,e){const s=this.config.luSlices,i=this.config.noLuSlices;return e?s<=5?!0:s<=20?t%2===0:s<=50?t%5===0:t%10===0:i<=20?(t-s)%2===0:i<=50?(t-s)%5===0:(t-s)%10===0}drawSliceText(t,e,s){const i=(t+e)/2,n=this.radius*.7,a=this.centerX+Math.cos(i)*n,o=this.centerY+Math.sin(i)*n;this.ctx.save(),this.ctx.translate(a,o),this.ctx.rotate(i+Math.PI/2),this.ctx.fillStyle="#000000",this.ctx.font="bold 14px Roboto, sans-serif",this.ctx.textAlign="center",this.ctx.textBaseline="middle";const r=s?"Lu!":"不Lu";this.ctx.fillText(r,0,0),this.ctx.restore()}drawCenter(){this.ctx.beginPath(),this.ctx.arc(this.centerX,this.centerY,30,0,2*Math.PI),this.ctx.fillStyle="#673AB7",this.ctx.fill(),this.ctx.strokeStyle=this.config.colors.border,this.ctx.lineWidth=3,this.ctx.stroke(),this.ctx.beginPath(),this.ctx.arc(this.centerX,this.centerY,22,0,2*Math.PI),this.ctx.fillStyle="#FFFFFF",this.ctx.fill()}async animateToSlice(t,e=5e3){if(this.isAnimating)throw new Error("Animation already in progress");this.isAnimating=!0;try{const s=2*Math.PI/this.config.totalSlices,i=t*s,n=(Math.random()-.5)*s*.8,o=this.currentAngle+12*2*Math.PI+i+n;await this.animateToAngle(o,e)}finally{this.isAnimating=!1}}async animateToAngle(t,e){return new Promise(s=>{const i=this.currentAngle,n=t-i,a=performance.now(),o=r=>{const l=r-a,u=Math.min(l/e,1),d=1-Math.pow(1-u,3);this.currentAngle=i+n*d,this.draw(),u<1?this.animationId=requestAnimationFrame(o):(this.animationId=null,s())};this.animationId=requestAnimationFrame(o)})}stopAnimation(){this.animationId&&(cancelAnimationFrame(this.animationId),this.animationId=null),this.isAnimating=!1}reset(){this.stopAnimation(),this.currentAngle=0,this.draw()}handleResize(){this.setupCanvas(),this.draw()}destroy(){this.stopAnimation(),this.canvas=null,this.ctx=null}}class x{constructor(t){this.gameLogic=new C(1),this.renderer=new D(t),this.syncRendererConfig()}setProbability(t){this.gameLogic.setProbability(t),this.syncRendererConfig()}syncRendererConfig(){const t=this.gameLogic.getWheelConfig();this.renderer.updateConfig(t)}async spin(){const t=this.gameLogic.roll();return await this.renderer.animateToSlice(t.sliceIndex),{isLu:t.isLu,result:t.isLu?"Lu":"不Lu",sliceIndex:t.sliceIndex}}async spinWithPity(){const t=this.gameLogic.forceResult(!0);return await this.renderer.animateToSlice(t.sliceIndex),{isLu:!0,result:"Lu",sliceIndex:t.sliceIndex,isPityTriggered:!0}}getProbability(){return this.gameLogic.probability}reset(){this.renderer.reset()}handleResize(){this.renderer.handleResize()}destroy(){this.renderer.destroy(),this.gameLogic=null,this.renderer=null}}class m{constructor(t=null){this.date=t||y(),this.spins=[]}addSpin(t,e=!1){this.spins.push({result:t,time:new Date().toISOString(),isPityTriggered:e})}get spinCount(){return this.spins.length}get finalResult(){return this.spins.length>0?this.spins[this.spins.length-1].result:null}get hasSpun(){return this.spins.length>0}canSpin(t){return t==="multi"?!0:this.spinCount===0}reset(){this.spins=[]}toJSON(){return{date:this.date,result:this.finalResult,spinCount:this.spinCount,isPityTriggered:this.spins.some(t=>t.isPityTriggered),timestamp:this.spins.length>0?this.spins[0].time:null}}static fromJSON(t){const e=new m(t.date);return t.result&&(e.spins=[{result:t.result,time:t.timestamp||new Date().toISOString(),isPityTriggered:t.isPityTriggered||!1}]),e}}class p{constructor(t=0){this.threshold=t,this.consecutiveFails=0}record(t){t==="不Lu"?this.consecutiveFails++:this.consecutiveFails=0}shouldTrigger(){return this.threshold>0&&this.consecutiveFails>=this.threshold}reset(){this.consecutiveFails=0}setThreshold(t){this.threshold=t}toJSON(){return{threshold:this.threshold,consecutiveFails:this.consecutiveFails}}static fromJSON(t){const e=new p(t.threshold||0);return e.consecutiveFails=t.consecutiveFails||0,e}}class f{constructor(){this.luProbability=1,this.pityDays=0,this.mode="single",this.soundEnabled=!0,this.animationEnabled=!0}update(t){t.luProbability!==void 0&&(this.luProbability=Math.max(1,Math.min(98,t.luProbability))),t.pityDays!==void 0&&(this.pityDays=Math.max(0,Math.min(365,t.pityDays))),t.mode!==void 0&&(this.mode=t.mode==="multi"?"multi":"single"),t.soundEnabled!==void 0&&(this.soundEnabled=!!t.soundEnabled),t.animationEnabled!==void 0&&(this.animationEnabled=!!t.animationEnabled)}static fromLegacySettings(t){const e=new f;return e.update({luProbability:t.luProbability||1,pityDays:t.pityDays||0,mode:t.multiMode?"multi":"single",soundEnabled:t.soundEnabled!==!1,animationEnabled:t.animationEnabled!==!1}),e}toLegacyFormat(){return{luProbability:this.luProbability,pityDays:this.pityDays,multiMode:this.mode==="multi",soundEnabled:this.soundEnabled,animationEnabled:this.animationEnabled}}}class w{constructor(){this.today=new m,this.config=new f,this.pityCounter=new p(0),this.isSpinning=!1}checkAndUpdateDate(){const t=y();this.today.date!==t&&(this.today=new m(t))}canSpin(){return this.isSpinning?{allowed:!1,reason:"spinning"}:this.today.canSpin(this.config.mode)?{allowed:!0,reason:null}:{allowed:!1,reason:"already_spun"}}recordSpin(t,e=!1){this.today.addSpin(t,e),this.pityCounter.record(t)}updateConfig(t){this.config.update(t),this.pityCounter.setThreshold(this.config.pityDays)}exportForPersistence(){return{today:this.today.toJSON(),config:this.config.toLegacyFormat(),pityCounter:this.pityCounter.toJSON()}}static fromPersistedData(t){const e=new w;return t.today&&(e.today=m.fromJSON(t.today)),t.config&&(e.config=f.fromLegacySettings(t.config)),t.pityCounter&&(e.pityCounter=p.fromJSON(t.pityCounter)),e.checkAndUpdateDate(),e}}class L{constructor(t,e){this.container=t,this.storageManager=e,this.selectedDate=null;const s=new Date;this.currentMonth=s.getUTCMonth(),this.currentYear=s.getUTCFullYear(),this.monthNames=["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"],this.onDateClick=null,this.init()}init(){this.render(),this.bindEvents()}setDateClickHandler(t){this.onDateClick=t}async render(){const t=await this.storageManager.getHistory();this.container.innerHTML=`
      <div class="calendar-header">
        <button class="calendar-nav-btn" id="prevMonth" aria-label="上个月">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
            <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
        <h3 class="calendar-title">${this.currentYear}年 ${this.monthNames[this.currentMonth]}</h3>
        <button class="calendar-nav-btn" id="nextMonth" aria-label="下个月">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
            <path d="M9 18L15 12L9 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>
      <div class="calendar-weekdays">
        <div class="weekday">日</div>
        <div class="weekday">一</div>
        <div class="weekday">二</div>
        <div class="weekday">三</div>
        <div class="weekday">四</div>
        <div class="weekday">五</div>
        <div class="weekday">六</div>
      </div>
      <div class="calendar-days" id="calendarDays">
        ${this.generateDaysHTML(t)}
      </div>
      <div class="calendar-legend">
        <div class="legend-item">
          <span class="legend-dot success"></span>
          <span>Lu</span>
        </div>
        <div class="legend-item">
          <span class="legend-dot failure"></span>
          <span>不Lu</span>
        </div>
        <div class="legend-item">
          <span class="legend-dot empty"></span>
          <span>未抽取</span>
        </div>
      </div>
    `,this.bindCalendarEvents()}generateDaysHTML(t){const e=new Date(this.currentYear,this.currentMonth,1),i=new Date(this.currentYear,this.currentMonth+1,0).getDate(),n=e.getDay();let a="";for(let r=0;r<n;r++)a+='<div class="calendar-day empty"></div>';const o=y();for(let r=1;r<=i;r++){const l=this.formatDate(this.currentYear,this.currentMonth,r),u=l===o,d=t[l];let g="empty",S="";d&&(g=d.result==="Lu"?"success":"failure",S=d.result,d.spinCount>1&&(S+=` (${d.spinCount})`)),a+=`
        <div class="calendar-day ${u?"today":""} ${g}" 
             data-date="${l}"
             title="${S||"未抽取"}"
             ${d||u?'data-clickable="true"':""}>
          <span class="day-number">${r}</span>
          <span class="day-status ${g}"></span>
        </div>
      `}return a}formatDate(t,e,s){return`${t}-${String(e+1).padStart(2,"0")}-${String(s).padStart(2,"0")}`}bindCalendarEvents(){const t=this.container.querySelector("#prevMonth"),e=this.container.querySelector("#nextMonth");t?.addEventListener("click",()=>this.navigateMonth(-1)),e?.addEventListener("click",()=>this.navigateMonth(1)),this.container.querySelector("#calendarDays")?.addEventListener("click",i=>{const n=i.target.closest('.calendar-day[data-clickable="true"]');if(n){const a=n.dataset.date;this.handleDateClick(a,n)}})}bindEvents(){window.addEventListener("resize",()=>{})}handleDateClick(t,e){this.selectedDate=t,this.container.querySelectorAll(".calendar-day.selected").forEach(s=>{s.classList.remove("selected")}),e.classList.add("selected"),this.onDateClick&&this.onDateClick(t)}async updateDisplay(){await this.render()}highlightDate(t){const[e,s,i]=t.split("-").map(Number);e!==this.currentYear||s-1!==this.currentMonth?(this.currentYear=e,this.currentMonth=s-1,this.render().then(()=>{this.highlightSpecificDay(t)})):this.highlightSpecificDay(t)}highlightSpecificDay(t){const e=this.container.querySelector(`[data-date="${t}"]`);e&&(this.container.querySelectorAll(".calendar-day.highlighted").forEach(s=>{s.classList.remove("highlighted")}),e.classList.add("highlighted"),e.scrollIntoView({behavior:"smooth",block:"nearest"}))}getCurrentMonth(){return{year:this.currentYear,month:this.currentMonth,monthName:this.monthNames[this.currentMonth]}}goToToday(){const t=new Date;this.currentYear=t.getUTCFullYear(),this.currentMonth=t.getUTCMonth(),this.render();const e=y();setTimeout(()=>{this.highlightSpecificDay(e)},100),nextBtn?.removeEventListener("click",()=>{}),calendarDays?.removeEventListener("click",()=>{}),this.container.innerHTML="",this.storageManager=null,this.onDateClick=null}}class T{constructor(t,e){this.elements={successCount:t.successCount,failureCount:t.failureCount,totalCount:t.totalCount,successRate:t.successRate},this.storageManager=e,this.currentStats={luCount:0,noLuCount:0,totalCount:0,successRate:0}}async init(){await this.updateStats()}async updateStats(){try{const t=await this.storageManager.getHistory(),e=this.calculateStats(t);this.currentStats=e,this.renderStats(e)}catch(t){console.error("Failed to update stats:",t),this.renderError()}}calculateStats(t){let e=0,s=0;Object.values(t).forEach(a=>{a&&a.result&&(a.result==="Lu"?e++:s++)});const i=e+s,n=i>0?s/i*100:0;return{luCount:e,noLuCount:s,totalCount:i,successRate:Math.round(n*100)/100}}renderStats(t){this.animateNumber(this.elements.successCount,t.luCount,"#F44336"),this.animateNumber(this.elements.failureCount,t.noLuCount,"#4CAF50"),this.animateNumber(this.elements.totalCount,t.totalCount,"#673AB7"),this.animatePercentage(this.elements.successRate,t.successRate)}animateNumber(t,e,s){if(!t)return;const i=parseInt(t.textContent)||0,n=800,a=performance.now(),o=r=>{const l=r-a,u=Math.min(l/n,1),d=this.easeOutCubic(u),g=Math.round(i+(e-i)*d);t.textContent=g,t.style.color=s,u<1&&requestAnimationFrame(o)};requestAnimationFrame(o)}animatePercentage(t,e){if(!t)return;const s=t.textContent.replace("%",""),i=parseFloat(s)||0,n=800,a=performance.now(),o=r=>{const l=r-a,u=Math.min(l/n,1),d=this.easeOutCubic(u),g=i+(e-i)*d;t.textContent=g.toFixed(1)+"%",g>=80?t.style.color="#4CAF50":g>=60?t.style.color="#FF9800":t.style.color="#F44336",u<1&&requestAnimationFrame(o)};requestAnimationFrame(o)}easeOutCubic(t){return 1-Math.pow(1-t,3)}renderError(){Object.values(this.elements).forEach(t=>{t&&(t.textContent="--",t.style.color="#999")})}getCurrentStats(){return{...this.currentStats}}async getDetailedStats(){try{const t=await this.storageManager.getHistory();return{...this.calculateStats(t),...this.calculateStreaks(t),...this.calculateMonthlyStats(t),...this.calculateWeeklyStats(t)}}catch(t){return console.error("Failed to get detailed stats:",t),this.currentStats}}calculateStreaks(t){const e=Object.keys(t).sort();let s=0,i=0,n=0,a=0,o=null;return e.forEach(r=>{const l=t[r];!l||!l.result||(l.result==="Lu"?(o==="Lu"?s++:(s=1,i=0),n=Math.max(n,s)):(o==="不Lu"?i++:(i=1,s=0),a=Math.max(a,i)),o=l.result)}),{currentLuStreak:s,currentNoLuStreak:i,maxLuStreak:n,maxNoLuStreak:a}}calculateMonthlyStats(t){const e={};Object.entries(t).forEach(([o,r])=>{if(!r||!r.result)return;const l=o.substring(0,7);e[l]||(e[l]={luCount:0,noLuCount:0,total:0}),e[l].total++,r.result==="Lu"?e[l].luCount++:e[l].noLuCount++});const s=new Date,i=`${s.getFullYear()}-${String(s.getMonth()+1).padStart(2,"0")}`,n=new Date(s.getFullYear(),s.getMonth()-1,1),a=`${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,"0")}`;return{monthlyData:e,currentMonthStats:e[i]||{luCount:0,noLuCount:0,total:0},lastMonthStats:e[a]||{luCount:0,noLuCount:0,total:0}}}calculateWeeklyStats(t){const e={};return Object.entries(t).forEach(([s,i])=>{if(!i||!i.result)return;const n=new Date(s),o=this.getWeekStart(n).toISOString().substring(0,10);e[o]||(e[o]={luCount:0,noLuCount:0,total:0}),e[o].total++,i.result==="Lu"?e[o].luCount++:e[o].noLuCount++}),{weeklyData:e}}getWeekStart(t){const e=t.getDay(),s=t.getDate()-e+(e===0?-6:1);return new Date(t.setDate(s))}async exportStats(){try{const t=await this.getDetailedStats();return{basic:this.currentStats,detailed:t,exportTime:new Date().toISOString(),version:"2.0"}}catch(t){throw console.error("Failed to export stats:",t),new Error("导出统计数据失败")}}resetDisplay(){this.currentStats={luCount:0,noLuCount:0,totalCount:0,successRate:0},this.renderStats(this.currentStats)}destroy(){this.elements={},this.storageManager=null,this.currentStats=null}}const E="lubulu_",c={SETTINGS:"settings",HISTORY:"spinHistory",DAILY_COUNTS:"dailySpinCounts",PITY_COUNTER:"pityCounter",APP_STATE:"app_state_v2"};class M{constructor(){this.defaults={[c.SETTINGS]:{luProbability:1,pityDays:0,multiMode:!1,soundEnabled:!0,animationEnabled:!0},[c.HISTORY]:{},[c.DAILY_COUNTS]:{},[c.PITY_COUNTER]:{threshold:0,consecutiveFails:0}}}_getKey(t){return E+t}_get(t){try{const e=localStorage.getItem(this._getKey(t));return e?JSON.parse(e):this.defaults[t]||null}catch(e){return console.error("Storage get failed:",e),this.defaults[t]||null}}_set(t,e){try{return localStorage.setItem(this._getKey(t),JSON.stringify(e)),!0}catch(s){return console.error("Storage set failed:",s),!1}}async getSettings(){return this._get(c.SETTINGS)}async saveSettings(t){return this._set(c.SETTINGS,t)}async getHistory(){return this._get(c.HISTORY)}async saveHistoryRecord(t,e,s=!1){const i=this._get(c.HISTORY)||{};return i[t]?(i[t].result=e,i[t].spinCount=(i[t].spinCount||1)+1,i[t].isPityTriggered=s,i[t].timestamp=new Date().toISOString()):i[t]={result:e,spinCount:1,isPityTriggered:s,timestamp:new Date().toISOString()},this._set(c.HISTORY,i)}async deleteHistoryRecord(t){const e=this._get(c.HISTORY)||{};return delete e[t],this._set(c.HISTORY,e)}async getDailyCount(t){return(this._get(c.DAILY_COUNTS)||{})[t]||0}async updateDailyCount(t,e){const s=this._get(c.DAILY_COUNTS)||{};return s[t]=e,this._set(c.DAILY_COUNTS,s)}async getPityCounter(){return this._get(c.PITY_COUNTER)}async savePityCounter(t){return this._set(c.PITY_COUNTER,t)}async getAppState(){return this._get(c.APP_STATE)}async saveAppState(t){return this._set(c.APP_STATE,t)}async exportData(){return{settings:this._get(c.SETTINGS),history:this._get(c.HISTORY),dailyCounts:this._get(c.DAILY_COUNTS),pityCounter:this._get(c.PITY_COUNTER),exportDate:new Date().toISOString()}}async importData(t){try{return t.settings&&this._set(c.SETTINGS,t.settings),t.history&&this._set(c.HISTORY,t.history),t.dailyCounts&&this._set(c.DAILY_COUNTS,t.dailyCounts),t.pityCounter&&this._set(c.PITY_COUNTER,t.pityCounter),!0}catch(e){return console.error("Import failed:",e),!1}}async clearAll(){try{return Object.values(c).forEach(t=>{localStorage.removeItem(this._getKey(t))}),!0}catch(t){return console.error("Clear all failed:",t),!1}}}class I{constructor(){this.activeDialogs=new Set,this.overlay=null,this.keyboardHandler=this.handleKeyboard.bind(this),this.init()}init(){this.createOverlay(),this.bindGlobalEvents()}createOverlay(){this.overlay=document.getElementById("overlay"),this.overlay||(this.overlay=document.createElement("div"),this.overlay.id="overlay",this.overlay.className="overlay hidden",document.body.appendChild(this.overlay)),this.overlay.addEventListener("click",t=>{t.target===this.overlay&&this.closeTopDialog()})}bindGlobalEvents(){document.addEventListener("keydown",this.keyboardHandler)}handleKeyboard(t){t.key==="Escape"&&this.activeDialogs.size>0&&(t.preventDefault(),this.closeTopDialog())}showDialog(t,e={}){const s=typeof t=="string"?document.getElementById(t):t;if(!s){console.error("Dialog element not found:",t);return}this.activeDialogs.add(s),this.overlay.classList.remove("hidden"),s.classList.remove("hidden"),setTimeout(()=>{this.overlay.classList.add("show"),s.classList.add("show")},10),e.autoFocus!==!1&&this.setFocusToDialog(s)}hideDialog(t){const e=typeof t=="string"?document.getElementById(t):t;e&&(this.activeDialogs.delete(e),e.classList.remove("show"),setTimeout(()=>{e.classList.add("hidden"),this.activeDialogs.size===0&&(this.overlay.classList.remove("show"),setTimeout(()=>{this.overlay.classList.add("hidden")},200))},200))}closeTopDialog(){if(this.activeDialogs.size>0){const t=Array.from(this.activeDialogs).pop();this.hideDialog(t)}}setFocusToDialog(t){const e=t.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');e.length>0?e[0].focus():t.focus()}closeAllDialogs(){Array.from(this.activeDialogs).forEach(e=>this.hideDialog(e))}}class R{constructor(){this.container=null,this.notifications=new Map,this.init()}init(){this.createContainer()}createContainer(){this.container=document.getElementById("notificationContainer"),this.container||(this.container=document.createElement("div"),this.container.id="notificationContainer",this.container.className="notification-container",document.body.appendChild(this.container))}show(t,e={}){const{type:s="info",duration:i=3e3,icon:n=this.getDefaultIcon(s),closable:a=!0,action:o=null}=e,r="notification_"+Date.now(),l=this.createNotificationElement(r,t,{type:s,icon:n,closable:a,action:o});this.container.appendChild(l),this.notifications.set(r,l),setTimeout(()=>{l.classList.add("show")},10),i>0&&setTimeout(()=>{this.hide(r)},i)}error(t,e={}){return this.show(t,{...e,type:"error",duration:5e3})}warning(t,e={}){return this.show(t,{...e,type:"warning",duration:4e3})}info(t,e={}){return this.show(t,{...e,type:"info"})}loading(t,e={}){return this.show(t,{...e,type:"loading",duration:0,closable:!1})}}class A{constructor(t){this.dialogManager=t,this.element=null,this.createDialog()}createDialog(){this.element=document.createElement("div"),this.element.className="dialog confirm-dialog hidden glass",this.element.innerHTML=`
      <div class="dialog-header">
        <h3 class="dialog-title">确认操作</h3>
      </div>
      <div class="dialog-body">
        <p class="dialog-message"></p>
      </div>
      <div class="dialog-actions">
        <button class="btn-secondary cancel-btn">取消</button>
        <button class="btn-primary confirm-btn">确定</button>
      </div>
    `,document.body.appendChild(this.element)}show(t={}){const{title:e="确认操作",message:s="确定要执行此操作吗？",confirmText:i="确定",cancelText:n="取消",type:a="default"}=t;return new Promise(o=>{this.element.querySelector(".dialog-title").textContent=e,this.element.querySelector(".dialog-message").textContent=s,this.element.querySelector(".confirm-btn").textContent=i,this.element.querySelector(".cancel-btn").textContent=n;const r=this.element.querySelector(".confirm-btn");r.className=a==="danger"?"btn-danger":"btn-primary";const l=()=>{u(),o(!0)},u=()=>{r.removeEventListener("click",l),this.element.querySelector(".cancel-btn").removeEventListener("click",handleCancel),this.dialogManager.hideDialog(this.element)};r.addEventListener("click",l),this.element.querySelector(".cancel-btn").addEventListener("click",handleCancel),this.dialogManager.showDialog(this.element)})}}class k{constructor(){this.context=null,this.enabled=!0,this.sounds=new Map,this.init()}async init(){try{this.context=new(window.AudioContext||window.webkitAudioContext),this.loadSounds()}catch(t){console.warn("Audio context not supported:",t)}}loadSounds(){this.sounds.set("spin",this.createSpinSound.bind(this)),this.sounds.set("success",this.createSuccessSound.bind(this)),this.sounds.set("failure",this.createFailureSound.bind(this)),this.sounds.set("click",this.createClickSound.bind(this))}createSpinSound(){if(!this.context)return;const t=this.context.createOscillator(),e=this.context.createGain();t.connect(e),e.connect(this.context.destination),t.type="sawtooth",t.frequency.setValueAtTime(200,this.context.currentTime),t.frequency.exponentialRampToValueAtTime(800,this.context.currentTime+.1),e.gain.setValueAtTime(.1,this.context.currentTime),e.gain.exponentialRampToValueAtTime(.01,this.context.currentTime+.5),t.start(this.context.currentTime),t.stop(this.context.currentTime+.5)}createSuccessSound(){if(!this.context)return;const t=this.context.createOscillator(),e=this.context.createGain();t.connect(e),e.connect(this.context.destination),t.type="sine",t.frequency.setValueAtTime(523.25,this.context.currentTime),t.frequency.setValueAtTime(659.25,this.context.currentTime+.1),t.frequency.setValueAtTime(783.99,this.context.currentTime+.2),e.gain.setValueAtTime(.1,this.context.currentTime),e.gain.exponentialRampToValueAtTime(.01,this.context.currentTime+.3),t.start(this.context.currentTime),t.stop(this.context.currentTime+.3)}createFailureSound(){if(!this.context)return;const t=this.context.createOscillator(),e=this.context.createGain();t.connect(e),e.connect(this.context.destination),t.type="sawtooth",t.frequency.setValueAtTime(220,this.context.currentTime),t.frequency.exponentialRampToValueAtTime(110,this.context.currentTime+.3),e.gain.setValueAtTime(.1,this.context.currentTime),e.gain.exponentialRampToValueAtTime(.01,this.context.currentTime+.3),t.start(this.context.currentTime),t.stop(this.context.currentTime+.3)}createClickSound(){if(!this.context)return;const t=this.context.createOscillator(),e=this.context.createGain();t.connect(e),e.connect(this.context.destination),t.type="square",t.frequency.setValueAtTime(800,this.context.currentTime),e.gain.setValueAtTime(.05,this.context.currentTime),e.gain.exponentialRampToValueAtTime(.01,this.context.currentTime+.1),t.start(this.context.currentTime),t.stop(this.context.currentTime+.1)}play(t){if(!this.enabled||!this.context)return;const e=this.sounds.get(t);if(e)try{e()}catch(s){console.warn("Failed to play sound:",s)}}setEnabled(t){this.enabled=t}async resumeContext(){if(this.context&&this.context.state==="suspended")try{await this.context.resume()}catch(t){console.warn("Failed to resume audio context:",t)}}}class F{constructor(){this.appState=new w,this.managers={roulette:null,calendar:null,statistics:null,storage:null,dialog:null,notification:null,audio:null},this.elements={},this.confirmDialog=null,this.debouncedUpdateStats=v(()=>{this.managers.statistics?.updateStats()},300),this.init()}async init(){try{await this.initializeManagers(),await this.initializeDOM(),await this.loadInitialData(),this.bindEvents(),this.setupGlobalErrorHandling(),console.log("Lubulu App v3.0-slim initialized successfully")}catch(t){console.error("Failed to initialize Lubulu App:",t),this.showCriticalError("应用初始化失败: "+t.message)}}async initializeManagers(){this.managers.storage=new M,this.managers.dialog=new I,this.managers.notification=new R,this.managers.audio=new k,this.confirmDialog=new A(this.managers.dialog)}async initializeDOM(){this.elements={canvas:document.getElementById("rouletteCanvas"),spinBtn:document.getElementById("spinBtn"),tooltip:document.getElementById("tooltip"),resultDisplay:document.getElementById("resultDisplay"),resultChoice:document.getElementById("resultChoice"),resultActions:document.getElementById("resultActions"),pityNotice:document.getElementById("pityNotice"),calendar:document.getElementById("calendar"),successCount:document.getElementById("successCount"),failureCount:document.getElementById("failureCount"),totalCount:document.getElementById("totalCount"),successRate:document.getElementById("successRate"),settingsBtn:document.getElementById("settingsBtn"),settingsDialog:document.getElementById("settingsDialog"),luProbabilitySlider:document.getElementById("luProbability"),luProbabilityValue:document.getElementById("luProbabilityValue"),pityDaysInput:document.getElementById("pityDays"),singleModeBtn:document.getElementById("singleModeBtn"),multiModeBtn:document.getElementById("multiModeBtn"),chooseYes:document.getElementById("chooseYes"),chooseNo:document.getElementById("chooseNo"),shareResult:document.getElementById("shareResult"),confirmResult:document.getElementById("confirmResult"),exportData:document.getElementById("exportDataBtn"),importData:document.getElementById("importDataBtn"),settingsSave:document.getElementById("settingsSaveBtn"),settingsCancel:document.getElementById("settingsCancelBtn")};const e=["canvas","spinBtn","calendar"].filter(s=>!this.elements[s]);if(e.length>0)throw new Error(`Missing required DOM elements: ${e.join(", ")}`);this.managers.roulette=new x(this.elements.canvas),this.managers.calendar=new L(this.elements.calendar,this.managers.storage),this.managers.statistics=new T({successCount:this.elements.successCount,failureCount:this.elements.failureCount,totalCount:this.elements.totalCount,successRate:this.elements.successRate},this.managers.storage)}async loadInitialData(){try{const t=await this.managers.storage.getSettings();this.applySettings(t);const e=await this.managers.storage.getPityCounter();e&&(this.appState.pityCounter.consecutiveFails=e.consecutiveFails||0,this.appState.pityCounter.threshold=e.threshold||0),await this.managers.statistics.init(),await this.checkTodayStatus()}catch(t){console.error("Failed to load initial data:",t),this.managers.notification.error("加载数据失败: "+t.message)}}bindEvents(){this.elements.spinBtn?.addEventListener("click",()=>this.handleSpinClick()),this.elements.chooseYes?.addEventListener("click",()=>this.handleResultChoice(!0)),this.elements.chooseNo?.addEventListener("click",()=>this.handleResultChoice(!1)),this.elements.confirmResult?.addEventListener("click",()=>this.handleResultConfirm()),this.elements.shareResult?.addEventListener("click",()=>this.handleShareResult()),this.elements.settingsBtn?.addEventListener("click",()=>this.showSettings()),this.elements.settingsSave?.addEventListener("click",()=>this.saveSettings()),this.elements.settingsCancel?.addEventListener("click",()=>this.cancelSettings()),this.elements.luProbabilitySlider?.addEventListener("input",t=>{this.elements.luProbabilityValue.textContent=t.target.value,this.managers.roulette?.setProbability(parseInt(t.target.value))}),this.elements.singleModeBtn?.addEventListener("click",()=>this.setMode("single")),this.elements.multiModeBtn?.addEventListener("click",()=>this.setMode("multi")),this.elements.exportData?.addEventListener("click",()=>this.exportData()),this.elements.importData?.addEventListener("click",()=>this.importData()),this.managers.calendar?.setDateClickHandler(t=>this.handleDateClick(t)),window.addEventListener("resize",v(()=>this.handleResize(),250)),window.addEventListener("beforeunload",()=>this.handleBeforeUnload()),document.addEventListener("click",()=>{this.managers.audio?.resumeContext()},{once:!0}),window.addEventListener("dataUpdated",t=>{this.handleDataUpdated(t.detail)})}setupGlobalErrorHandling(){window.addEventListener("error",t=>{console.error("Global error:",t.error)}),window.addEventListener("unhandledrejection",t=>{console.error("Unhandled promise rejection:",t.reason)})}async handleSpinClick(){this.appState.checkAndUpdateDate();const t=this.appState.canSpin();if(!t.allowed){t.reason==="already_spun"&&this.managers.notification.warning("今日已经抽取过了");return}try{if(this.appState.config.mode==="single"&&!await this.confirmDialog.show({message:"确定今日要抽取吗?",confirmText:"确定抽取"}))return;await this.performSpin()}catch(e){console.error("Spin failed:",e),this.managers.notification.error(e.message)}}async performSpin(){this.appState.isSpinning=!0,this.updateSpinButton();try{this.managers.audio?.play("spin");const t=this.appState.pityCounter.shouldTrigger();let e;t?e=await this.managers.roulette.spinWithPity():e=await this.managers.roulette.spin(),this.managers.audio?.play(e.isLu?"success":"failure"),this.showSpinResult(e)}catch(t){throw this.appState.isSpinning=!1,this.updateSpinButton(),t}}showSpinResult(t){const e=this.elements.resultDisplay;if(!e)return;e.classList.remove("hidden");const s=e.querySelector(".result-icon"),i=e.querySelector(".result-text");t.isLu?(s.textContent="🎉",i.textContent="Lu!",i.style.color="#F44336"):(s.textContent="💪",i.textContent="不Lu",i.style.color="#4CAF50"),t.isPityTriggered&&this.elements.pityNotice?.classList.remove("hidden"),t.isLu?this.elements.resultChoice?.classList.remove("hidden"):(this.saveSpinResultDirectly(t.result,t.isPityTriggered),this.elements.resultActions?.classList.remove("hidden"))}async saveSpinResultDirectly(t,e=!1){this.appState.recordSpin(t,e),await this.managers.storage.saveHistoryRecord(this.appState.today.date,t,e),await this.managers.storage.savePityCounter(this.appState.pityCounter.toJSON()),this.updateSpinButton(),this.debouncedUpdateStats(),this.managers.calendar?.updateDisplay()}async handleResultChoice(t){try{const e=t?"Lu":"不Lu";this.elements.resultChoice?.classList.add("hidden");const s=this.elements.resultDisplay?.querySelector(".result-text");s&&(s.textContent=e,s.style.color=t?"#F44336":"#4CAF50"),await this.saveSpinResultDirectly(e,this.elements.pityNotice&&!this.elements.pityNotice.classList.contains("hidden")),this.elements.resultActions?.classList.remove("hidden")}catch(e){console.error("Failed to handle result choice:",e),this.managers.notification.error("保存结果失败")}}handleResultConfirm(){if(!this.elements.resultChoice?.classList.contains("hidden")){this.handleResultChoice(!1);return}this.resetSpinState()}resetSpinState(){this.appState.isSpinning=!1,this.elements.resultDisplay?.classList.add("hidden"),this.elements.resultChoice?.classList.add("hidden"),this.elements.resultActions?.classList.add("hidden"),this.elements.pityNotice?.classList.add("hidden"),this.updateSpinButton()}updateSpinButton(){const t=this.elements.spinBtn,e=this.elements.tooltip;if(!t)return;if(this.appState.isSpinning){t.textContent="转动中...",t.disabled=!0,e?.classList.add("hidden");return}this.appState.canSpin().allowed?(t.textContent="SPIN",t.disabled=!1,e?.classList.add("hidden")):(t.textContent="已完成",t.disabled=!0,e?.classList.remove("hidden"))}async checkTodayStatus(){const e=(await this.managers.storage.getHistory())[this.appState.today.date];e&&(this.appState.today=this.appState.today.constructor.fromJSON(e)),this.updateSpinButton()}applySettings(t){this.appState.updateConfig(t),this.managers.roulette?.setProbability(this.appState.config.luProbability),this.elements.luProbabilitySlider&&(this.elements.luProbabilitySlider.value=this.appState.config.luProbability,this.elements.luProbabilityValue.textContent=this.appState.config.luProbability),this.elements.pityDaysInput&&(this.elements.pityDaysInput.value=this.appState.config.pityDays),this.updateModeButtons(),this.managers.audio?.setEnabled(this.appState.config.soundEnabled)}updateModeButtons(){const t=this.elements.singleModeBtn,e=this.elements.multiModeBtn;this.appState.config.mode==="multi"?(t?.classList.remove("active"),e?.classList.add("active")):(t?.classList.add("active"),e?.classList.remove("active")),this.updateSpinButton()}setMode(t){this.appState.config.mode=t,this.updateModeButtons()}async showSettings(){try{const t=await this.managers.storage.getSettings();this.elements.luProbabilitySlider&&(this.elements.luProbabilitySlider.value=t.luProbability,this.elements.luProbabilityValue.textContent=t.luProbability),this.elements.pityDaysInput&&(this.elements.pityDaysInput.value=t.pityDays),this.setMode(t.multiMode?"multi":"single"),this.managers.dialog.showDialog("settingsDialog")}catch(t){console.error("Failed to show settings:",t),this.managers.notification.error("打开设置失败")}}async saveSettings(){try{const t={luProbability:parseInt(this.elements.luProbabilitySlider?.value||1),pityDays:parseInt(this.elements.pityDaysInput?.value||0),multiMode:this.appState.config.mode==="multi",soundEnabled:!0,animationEnabled:!0};await this.managers.storage.saveSettings(t),this.applySettings(t),this.managers.dialog.hideDialog("settingsDialog"),this.managers.notification.success("设置已保存")}catch(t){console.error("Failed to save settings:",t),this.managers.notification.error(t.message)}}cancelSettings(){this.managers.dialog.hideDialog("settingsDialog")}async exportData(){try{const t=await this.managers.storage.exportData(),e=new Blob([JSON.stringify(t,null,2)],{type:"application/json"}),s=URL.createObjectURL(e),i=document.createElement("a");i.href=s,i.download=`lubulu_backup_${new Date().toISOString().split("T")[0]}.json`,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(s),this.managers.notification.success("数据导出成功")}catch(t){console.error("Failed to export data:",t),this.managers.notification.error(t.message)}}async importData(){try{if(!await this.confirmDialog.show({title:"确认导入",message:"确定要导入数据吗?这将覆盖当前的所有数据!",type:"danger"}))return;const e=document.createElement("input");e.type="file",e.accept=".json",e.onchange=async s=>{const i=s.target.files[0];if(i)try{const n=await i.text(),a=JSON.parse(n);await this.managers.storage.importData(a),await this.loadInitialData(),this.managers.notification.success("数据导入成功")}catch(n){console.error("Failed to import data:",n),this.managers.notification.error("数据导入失败: "+n.message)}},e.click()}catch(t){console.error("Failed to import data:",t),this.managers.notification.error(t.message)}}async handleDateClick(t){try{const s=(await this.managers.storage.getHistory())[t],i=this.appState.today.date;let n,a;t===i?(n=`编辑今日记录 (${t})`,a=["设为Lu","设为不Lu","清除记录"]):(n=`编辑历史记录 (${t})`,a=s?["设为Lu","设为不Lu","清除记录"]:["设为Lu","设为不Lu"]);const o=await this.showHistoryEditDialog(n,a,s);o!==null&&await this.updateHistoryRecord(t,o)}catch(e){console.error("Failed to handle date click:",e),this.managers.notification.error("操作失败")}}async showHistoryEditDialog(t,e,s){return new Promise(i=>{const n=document.createElement("div");n.className="dialog history-edit-dialog hidden glass",n.innerHTML=`
        <div class="dialog-header">
          <h3>${t}</h3>
        </div>
        <div class="dialog-body">
          <p>当前状态: ${s?s.result:"无记录"}</p>
          <div class="history-edit-buttons">
            ${e.map((o,r)=>`<button class="choice-btn" data-choice="${r}">${o}</button>`).join("")}
          </div>
        </div>
        <div class="dialog-actions">
          <button class="btn-secondary cancel-btn">取消</button>
        </div>
      `,document.body.appendChild(n);const a=()=>{document.body.removeChild(n),this.managers.dialog.hideDialog(n)};n.addEventListener("click",o=>{if(o.target.classList.contains("choice-btn")){const r=parseInt(o.target.dataset.choice);a(),i(r)}else o.target.classList.contains("cancel-btn")&&(a(),i(null))}),this.managers.dialog.showDialog(n)})}async updateHistoryRecord(t,e){const i=["Lu","不Lu",null][e];await this.managers.storage.updateHistoryRecord(t,i),t===this.appState.today.date&&(i===null?this.appState.today.reset():await this.checkTodayStatus(),this.updateSpinButton()),await this.recalculatePityCounter(),this.debouncedUpdateStats(),this.managers.calendar?.updateDisplay();const n=i===null?"清除":`设置为${i}`;this.managers.notification.success(`${t} 记录已${n}`)}async recalculatePityCounter(){const t=await this.managers.storage.getHistory(),e=Object.keys(t).sort().reverse();let s=0;for(const i of e){if(i>=this.appState.today.date)continue;const n=t[i];if(!n||n.result!=="不Lu")break;s++}this.appState.pityCounter.consecutiveFails=s,await this.managers.storage.savePityCounter(this.appState.pityCounter.toJSON())}async handleShareResult(){try{if(!window.html2canvas){this.managers.notification.warning("截图功能未加载");return}(await html2canvas(document.body,{backgroundColor:"#EDE7F6",scale:1,useCORS:!0})).toBlob(e=>{const s=URL.createObjectURL(e),i=document.createElement("a");i.href=s,i.download=`lubulu_result_${new Date().toISOString().split("T")[0]}.png`,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(s),this.managers.notification.success("截图保存成功")})}catch(t){console.error("Failed to share result:",t),this.managers.notification.error("分享失败")}}handleResize(){this.managers.roulette?.handleResize()}handleBeforeUnload(){try{const t=this.appState.exportForPersistence();localStorage.setItem("lubulu_app_state_v2",JSON.stringify(t))}catch(t){console.warn("Failed to save app state:",t)}}showCriticalError(t){const e=document.createElement("div");e.className="critical-error",e.innerHTML=`
      <div class="error-content">
        <h2>⚠️ 应用错误</h2>
        <p>${t}</p>
        <button onclick="location.reload()" class="btn-primary">刷新页面</button>
      </div>
    `;const s=document.createElement("style");s.textContent=`
      .critical-error {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
      }
      .error-content {
        background: white;
        padding: 2rem;
        border-radius: 12px;
        text-align: center;
        max-width: 400px;
      }
    `,document.head.appendChild(s),document.body.appendChild(e)}async handleDataUpdated(t={}){try{const{reason:e}=t;e==="migration"&&(await this.loadInitialData(),this.debouncedUpdateStats(),this.updateSpinButton(),this.managers.calendar&&await this.managers.calendar.updateDisplay())}catch(e){console.error("处理数据更新事件失败:",e.message),this.managers.notification.warning("数据刷新时出现问题,请刷新页面")}}destroy(){Object.values(this.managers).forEach(t=>{t&&typeof t.destroy=="function"&&t.destroy()}),this.dataMigration&&(this.dataMigration=null),window.removeEventListener("resize",this.handleResize),window.removeEventListener("beforeunload",this.handleBeforeUnload),window.removeEventListener("dataUpdated",this.handleDataUpdated),this.appState=null,this.managers={},this.elements={}}}document.addEventListener("DOMContentLoaded",()=>{window.lubuluApp=new F});
